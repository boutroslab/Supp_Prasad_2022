---
title: "RNA_Seq_AnalysisCalu3_Mock_Cov2"
output:
  html_document: default
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

#Setup

First we need to load all sorts of packages that enable us to analyze a read count table that we generated using the nextflow nf-core pipeline version 1.4.3 on a fused genome build of human and SARS-Cov2.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tximportData)
library(ggrepel)
library(DESeq2)
library(tidyverse)
library(patchwork)
library(ggrastr)
library(fgsea)

```


## B110 Theme

```{r theme, include=FALSE}

theme_b110 <- function(){
  theme_classic() +
  theme(
    axis.text = element_text(size = 10), 
    axis.title = element_text(size = 10),
    plot.title = element_text(size = 12,hjust = 0.5,face = "bold"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    legend.position = "bottom"
    )
}

```

## B110 Colors

```{r colors}

sgi_blue    = '#5087C8'
sgi_yellow1 = '#F2EE35'
sgi_yellow2 = '#FED98E'
b110_grey   = '#808080'
b110_grey_light   = '#909090'
b110_transparent_black = alpha('#000000',0.5)
google_red = '#dd4b39'
google_green = '#0F9D58'
google_yellow = '#F4B400'
google_blue = '#4285F4'

```



#import the data from star

```{r,warning=F,message=F}

#require(tximport)
#txi <- tximport(files, type = "salmon", tx2gene = tx2gene,ignoreTxVersion = TRUE)
#names(txi)

star_data <- read_delim("data/merged_gene_counts.txt",delim = "\t")

colnames(star_data) <- gsub(pattern = "(\\S+?)Aligned.sortedByCoord.out.bam",replacement = "\\1",x = colnames(star_data))

star_data_id2name <- star_data %>% select(-starts_with("AS"))


star_data %<>%
  gather(run,count,-Geneid,-gene_name) %>% 
  separate(run,c("AS","number1","LR","number2")) %>%
  group_by(Geneid,gene_name,AS,number1) %>%
  summarise(count=sum(count)) %>%
  ungroup() %>% 
  select(Geneid,gene_name,number1,count) %>%
  spread(number1,count)

star_data %<>% 
  select(-gene_name) %>% 
  column_to_rownames("Geneid") %>% 
  as.data.frame()

#star_data <- star_data[-grep("ENSSAS",rownames(star_data)),]

```

## Read in the meta data

```{r meta_data}

raw_meta_data <- read_delim("meta_data/31983_meta.tsv",delim = "\t")

raw_meta_data %<>% 
  filter(grepl("R1",FASTQ_FILE)) %>% 
  mutate(
    run = gsub(pattern = "(.+)_.*.fastq.gz",
               replacement = "\\1",x = FASTQ_FILE)) %>% 
  dplyr::rename(sample = SAMPLE_NAME)


```
#prepare the DESeq2 data object

```{r,warning=F,message=F}

#from the raw annotation file we need to extract the treatment and time conditions 

# in theory this could add power to the differemt block countin similar adjacent time points as replicates if this is needed

raw_meta_data <-
    raw_meta_data %>% separate(sample,c("number","infection","treatment","concentration"),remove = F,sep = "[|\ |\\-|_]") %>%
  select(run,sample,infection,treatment,concentration) %>%
  distinct() %>%
  extract(run,"run","AS-(\\d+)-.+") %>%
  mutate(concentration=if_else(is.na(concentration),"0µM",concentration)) %>%
  filter(concentration!="1µM",concentration!="50µM") %>%
  select(-concentration)
 # mutate(treatment=if_else(treatment!="NonInf","drug",treatment),
   #      )) %>%
 # mutate(concentration=gsub("µ","u",concentration))
  

```

#lets check the percent of viral reads per sample

Because of the nature of the experiment a lot of reads fall onto the viral genome of SARS-Cov2. Thus, we check the percentage of SARS RNA reads in each sample.

```{r}

plot_data <- 
  star_data %>% 
  rownames_to_column("gene_id") %>% 
  gather(sample,reads,-gene_id) %>% 
  mutate(viral_read = grepl("ENSSAS",gene_id)) %>% 
  group_by(sample,viral_read) %>% 
  summarise(read_count=sum(reads)) %>% 
  rename(run=sample) %>% 
  left_join(raw_meta_data) %>%
  arrange(infection,treatment) %>%
  distinct() %>% drop_na()

a <-  plot_data %>% ggplot(aes(x=sample,y=read_count,fill=viral_read)) + geom_bar(stat = "identity",position="stack" ) + theme_b110() +scale_fill_manual(values = c(b110_grey,google_red)) + theme(axis.text.x = element_text(angle = 45, vjust = 0.8, hjust=0.9))

b <- plot_data %>% ggplot(aes(x=sample,y=read_count,fill=viral_read)) + geom_bar(stat = "identity",position="stack" ) + theme_b110() +scale_fill_manual(values = c(b110_grey,google_red)) + theme(axis.text.x = element_text(angle = 45, vjust = 0.8, hjust=0.9))+ facet_wrap(~viral_read)

c <- plot_data %>% ggplot(aes(x=sample,y=read_count,fill=viral_read)) + geom_bar(stat = "identity",position="fill" ) + theme_b110() +scale_fill_manual(values = c(b110_grey,google_red)) + theme(axis.text.x = element_text(angle = 45, vjust = 0.8, hjust=0.9))

a + b + c + plot_layout(nrow = 2,ncol = 2)

ggsave("plots/per_cent_viral_reads.pdf",a + b + c + plot_layout(nrow = 2,ncol = 2),width = 16,height = 12)
```



## Analysis for drug testing

# design table preparation

```{r}

sampleTable_drug_experiment <- 
  raw_meta_data %>% 
    #filter(concentration %in% c("2uM","1uM","0uM"),treatment %in% c("drug","DMSO"))  %>%
    mutate(treatment=if_else(treatment=="4µ8C","4u8C",treatment)) %>%
    distinct() %>%
    mutate(infection=factor(infection)) %>% 
    as_data_frame()

rownames(sampleTable_drug_experiment)<-sampleTable_drug_experiment$run

```


#simple prefiltering

```{r,warning=F,message=F}
star_data_drug_experiment <- star_data[,rownames(sampleTable_drug_experiment)]

dds_drug_experiment <- DESeqDataSetFromMatrix(star_data_drug_experiment, sampleTable_drug_experiment, ~infection+treatment)

#counting transcripts

nrow(dds_drug_experiment)

#excluding genes that were not matched at all
dds_drug_experiment <- dds_drug_experiment[ rowSums(counts(dds_drug_experiment)) > 1, ]
nrow(dds_drug_experiment)

#remaining 27598

```

#stabilize variance for low readcount genes

```{r,warning=F,message=F}

vsd <- vst(dds_drug_experiment, blind = FALSE)

```

#cluster data to get an overview

Treatments should cluster together

```{r,warning=F,message=F}
require("pheatmap")
require("RColorBrewer")

sampleDists <- dist(t(assay(vsd)))
sampleDistMatrix <- as.matrix( sampleDists )
rownames(sampleDistMatrix) <- vsd$sample
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
annotations = data.frame("virus"=vsd$infection)
row.names(annotations)<-vsd$sample

pheatmap(sampleDistMatrix,
         clustering_distance_rows = sampleDists,
         clustering_distance_cols = sampleDists,
         col = colors,annotation_row = annotations)

c <- plotPCA(vsd, c("infection")) + ggtitle("PCA by virus") + theme_b110()
d <- plotPCA(vsd, c("treatment")) + ggtitle("PCA by drug")+ theme_b110()

print(c+d)
ggsave(c+d,filename = "plots/PCA_pre_batch_correct_dds_drug_experiment_wCov2.pdf")

```

# lets call differential genes

```{r,warning=F,message=F}

dds <- DESeq(dds_drug_experiment)

# get available contrasts

resultsNames(dds)

# choose the contrast which shows the difference between treatments given background differences of the treatment response over time.

x4u8C_over_Mock <- results(dds,contrast = c("treatment","4u8C","DMSO"))

xkira_over_Mock <- results(dds,contrast = c("treatment","KIRA8","DMSO"))

xkira_over_4u8C <- results(dds,contrast = c("treatment","KIRA8","4u8C"))

Cov2_over_Mock <- results(dds,contrast = c("infection","NonInf","MOI10"))

summary(xkira_over_Mock)

summary(x4u8C_over_Mock)

summary(xkira_over_4u8C)

summary(Cov2_over_Mock)
#res %>% as.data.frame() %>% View()
# --> there is quite a number of genes differential expressed --> lets look at who they are
```



# Cov2 vs drug

```{r,warning=F,message=F}

plotCounts(dds, gene = "ENSG00000051523", intgroup = c("treatment"),returnData = F) 

# here we threshold the data simply in upregulated and down regulated according to foldchange and sort by FDR
# for enrichment of functional annotation clustering it make further sense to threshold by fold change and FDR

xkira_over_4u8C %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "Geneid") %>% 
  left_join(star_data_id2name)  %>%
  arrange(padj) %>% 
  write_delim(path = "processed_data/star_top_table_xkira_over_4u8C_full.txt",delim = "\t")

down_regulated_genes_drug <- xkira_over_4u8C %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "Geneid") %>% 
  left_join(star_data_id2name)  %>% 
  arrange(padj) %>% 
  filter(log2FoldChange<0,padj<0.1)
  
write_delim(down_regulated_genes_drug,"processed_data/star_top_table_xkira_over_4u8C_downdrug.txt",delim = "\t")

up_regulated_genes_drug <- xkira_over_4u8C %>% 
  as.data.frame() %>%
  rownames_to_column(var = "Geneid") %>%  
  left_join(star_data_id2name)  %>% 
  arrange(padj) %>% 
  filter(log2FoldChange>0,padj<0.1)

write_delim(up_regulated_genes_drug,"processed_data/star_top_table_xkira_over_4u8C_updrug.txt",delim = "\t")


```

##Vizual inspection

#xdrug_over_Mock

```{r}
# next we visualize the differential expressed genes using MA plot of base line expression versus fold change and foldchange versus -log10 pvalue
# here all genes that are deferentially expressed between SARS-Cov2 infection and Mock treatment with an FDR < 0.1 are colored blue.
# the top 15 differentially expressed genes according the the FDR ranking are labeled by their official gene symbol

this_data <- xkira_over_4u8C  %>%
  as.data.frame() %>% 
  rownames_to_column(var = "Geneid") %>%  
  left_join(star_data_id2name) %>% 
  mutate(significant = if_else(padj<=0.1,"significant","non-significant")) %>%
  drop_na()

 p1 <-this_data %>%
         ggplot(aes(x=log2FoldChange,y=-log10(pvalue),col=significant,key=Geneid,gene_id=gene_name))  +
            geom_point_rast(data = this_data %>% filter(significant=="non-significant"),alpha=0.3) +
            geom_point_rast(data = this_data %>% filter(significant!="non-significant")) +
            geom_vline(xintercept = 0,lty=2,col=b110_grey_light) +
           geom_label_repel(data = this_data %>% filter(significant=="significant") %>% arrange(padj) %>% head(.,30),aes(label=gene_name),col=b110_grey,min.segment.length = 0) +
            theme_b110() +
            scale_color_manual(values = c(b110_grey_light,google_blue))+ 
            ggtitle("Treatment differential Volcano-plot")


p2 <-this_data %>%
  ggplot(aes(x=baseMean,y=log2FoldChange,col=significant,key=Geneid,gene_id=gene_name)) +
    geom_point_rast(data = subset(this_data,significant=="non-significant"),alpha=0.3) +
    geom_smooth(col="black") +
    geom_point_rast(data = subset(this_data,significant=="significant")) +
     geom_label_repel(data = this_data %>% filter(significant=="significant") %>% arrange(padj) %>% head(.,15),aes(label=gene_name),col=b110_grey,min.segment.length = 0) +
    theme_b110() +
    scale_color_manual(values = c(b110_grey_light,google_blue)) + 
    ggtitle("Treatment differential MA-plot") +
    scale_x_log10()

ggsave(p1,filename = "plots/star_differential_expressed_volcano_xkira_over_4u8C.pdf")
ggsave(p2,filename = "plots/star_differential_expressed_MA_xkira_over_4u8C.pdf")

# next we visualize the same data without the viral genes


this_data <- xkira_over_4u8C  %>%
  as.data.frame() %>% 
  rownames_to_column(var = "Geneid") %>%  
  left_join(star_data_id2name) %>% 
  mutate(significant = if_else(padj<=0.1,"significant","non-significant")) %>%
  drop_na() %>%
  filter(grepl("ENSG",Geneid))

 p1 <-this_data %>%
         ggplot(aes(x=log2FoldChange,y=-log10(pvalue),col=significant,key=Geneid,gene_id=gene_name))  +
            geom_point_rast(data = this_data %>% filter(significant=="non-significant"),alpha=0.3) +
            geom_point_rast(data = this_data %>% filter(significant!="non-significant")) +
            geom_vline(xintercept = 0,lty=2,col=b110_grey_light) +
           geom_label_repel(data = this_data %>% filter(significant=="significant") %>% arrange(padj) %>% head(.,30),aes(label=gene_name),col=b110_grey,min.segment.length = 0) +
            theme_b110() +
            scale_color_manual(values = c(b110_grey_light,google_blue))+ 
            ggtitle("Treatment differential Volcano-plot")


p2 <-this_data %>%
  ggplot(aes(x=baseMean,y=log2FoldChange,col=significant,key=Geneid,gene_id=gene_name)) +
    geom_point_rast(data = subset(this_data,significant=="non-significant"),alpha=0.3) +
    geom_smooth(col="black") +
    geom_point_rast(data = subset(this_data,significant=="significant")) +
     geom_label_repel(data = this_data %>% filter(significant=="significant") %>% arrange(padj) %>% head(.,15),aes(label=gene_name),col=b110_grey,min.segment.length = 0) +
    theme_b110() +
    scale_color_manual(values = c(b110_grey_light,google_blue)) + 
    ggtitle("Treatment differential MA-plot") +
    scale_x_log10()

ggsave(p1,filename = "plots/star_differential_expressed_volcano_xkira_over_4u8C_woCov2.pdf")
ggsave(p2,filename = "plots/star_differential_expressed_MA_xkira_over_4u8C_woCov2.pdf")
```

```{r}

tibble("Geneid"=rownames(xkira_over_4u8C)) %>% left_join(star_data_id2name) %>% write_delim("processed_data/detected_genes_drug_experiment.txt",delim = "\t")

```

# Session info

```{r}
writeLines(capture.output(sessionInfo()), "processed_data/SessionInfo_drug_experiment.txt")
```







